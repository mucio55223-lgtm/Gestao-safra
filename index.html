<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Recep√ß√£o de Trigo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            /* Cores padr√£o do tema (Bootstrap-like) - Ser√£o sobrescritas pelo servidor */
            --primary-color: #0d6efd; 
            --primary-hover-color: #0b5ed7;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        /* Aplica as vari√°veis CSS ao design */
        .btn-primary { background-color: var(--primary-color) !important; border-color: var(--primary-color) !important; }
        .btn-primary:hover { background-color: var(--primary-hover-color) !important; border-color: var(--primary-hover-color) !important; }
        .kpi-card-primary { border-left-color: var(--primary-color); }
        .kpi-card-success { border-left-color: var(--success-color); }
        .kpi-card-warning { border-left-color: var(--warning-color); }
        
        /* Estilos mantidos */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .status-ok { background-color: #d4edda; color: var(--success-color); }
        .status-andamento { background-color: #fff3cd; color: var(--warning-color); }
        .status-falta-receber { background-color: #f8d7da; color: var(--danger-color); }
        .status-prev-invalida { background-color: #f0f0f0; color: #6c757d; }
        .kpi-card { border-radius: 0.5rem; border-left: 5px solid; }
        .editable-title { cursor: pointer; }
        .cultivar-row:hover { background-color: #e9ecef; cursor: pointer; }
        .progress-chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            margin: auto;
        }
        .progress-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
        }
        .plotly-iframe {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 0.5rem;
        }
        .plotly-iframe.height-600 {
            height: 600px;
        }
        .positive-diff { color: var(--success-color); font-weight: bold; }
        .negative-diff { color: var(--danger-color); font-weight: bold; }
        .neutral-diff { color: var(--warning-color); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4 p-2 bg-white shadow-sm rounded-lg">
            <h1 id="dashboardTitle" class="mb-0 fs-3 editable-title" onclick="editTitle('dashboardTitle')" title="Clique para editar o nome">
                Dashboard de Recep√ß√£o de Trigo üåæ
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#configModal">
                ‚öôÔ∏è Configura√ß√µes
            </button>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">üìä Dashboard & Progresso Individual</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="avancado-tab" data-bs-toggle="tab" data-bs-target="#avancado" type="button" role="tab">üöÄ Gr√°ficos Avan√ßados</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analise-tab" data-bs-toggle="tab" data-bs-target="#analise" type="button" role="tab">üìà An√°lise Detalhada</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tabela-tab" data-bs-toggle="tab" data-bs-target="#tabela" type="button" role="tab">üìã Edi√ß√£o R√°pida da Tabela</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button" role="tab">‚ûï Cadastro & Op√ß√µes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="slideshow-tab" onclick="window.open('/slideshow', '_blank')" type="button">üé¨ Slideshow</button>
            </li>
        </ul>

        <div class="tab-content bg-white p-4 shadow-sm rounded-bottom" id="myTabContent">
            
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" tabindex="0">
                <div class="p-3">
                    <h2>Vis√£o Geral da Recep√ß√£o</h2>
                    
                    <div class="row mb-5">
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-primary">
                                <p class="text-muted mb-0">Total Previsto (SC)</p>
                                <h3 class="mb-0" id="kpiTotalPrevisto">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-warning">
                                <p class="text-muted mb-0">Total Recebido (SC)</p>
                                <h3 class="mb-0" id="kpiTotalRecebido">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-success">
                                <p class="text-muted mb-0">Progresso Geral (%)</p>
                                <h3 class="mb-0" id="kpiProgressoGeral">0%</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-primary">
                                <p class="text-muted mb-0">Cultivares Cadastradas</p>
                                <h3 class="mb-0" id="kpiCultivares">0</h3>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-5">
                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <h4>üîç Selecione uma Cultivar</h4>
                                <p class="text-muted small">Clique na linha da cultivar abaixo para ver seu progresso individual.</p>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-hover" id="cultivarSelectTable">
                                        <thead>
                                            <tr>
                                                <th>Cultivar</th>
                                                <th>%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card p-3 h-100 text-center">
                                <h4 id="progressTitle">Progresso Individual (Selecione ao lado)</h4>
                                <div class="progress-chart-container">
                                    <canvas id="chartIndividualProgress"></canvas>
                                    <div class="progress-label" id="progressPercentage">--</div>
                                </div>
                                <p class="text-muted mt-2 mb-0 small" id="progressDetails">Previsto: -- | Recebido: --</p>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card p-3 h-100">
                                <h4>Distribui√ß√£o de Status (Passe o mouse para ver Cultivares)</h4>
                                <canvas id="chartStatus"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="avancado" role="tabpanel" tabindex="0">
                <div class="p-3">
                    <h2>Visualiza√ß√µes Did√°ticas (Plotly)</h2>
                    <p class="text-muted">Estes gr√°ficos s√£o interativos. Clique no √≠cone de engrenagem para editar os t√≠tulos.</p>
                    
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h4 id="barGroupedTitle">1. Previsto vs. Recebido (Barras Agrupadas)</h4>
                                <iframe id="iframeBarGrouped" class="plotly-iframe height-400"></iframe>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h4 id="treemapTitle">2. Propor√ß√£o do Recebido (Gr√°fico de Pizza)</h4>
                                <iframe id="iframeTreemap" class="plotly-iframe height-400"></iframe>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card p-3">
                                <h4 id="sankeyTitle">3. Fluxo de Volume (Sankey Diagram)</h4>
                                <iframe id="iframeSankey" class="plotly-iframe height-600"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="analise" role="tabpanel" tabindex="0">
                <div class="p-3">
                    <h2>An√°lise Detalhada e M√©tricas Avan√ßadas</h2>
                    <p class="text-muted">Visualiza√ß√µes avan√ßadas para an√°lise de desempenho e proje√ß√µes.</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-success">
                                <p class="text-muted mb-0">Excedente Total (SC)</p>
                                <h3 class="mb-0" id="kpiExcedenteTotal">0</h3>
                                <small class="text-muted">Volume acima da previs√£o</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-warning">
                                <p class="text-muted mb-0">Cultivares com Excedente</p>
                                <h3 class="mb-0" id="kpiCultivaresExcedente">0</h3>
                                <small class="text-muted">Acima da meta</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-primary">
                                <p class="text-muted mb-0">Maior Excedente</p>
                                <h3 class="mb-0" id="kpiMaiorExcedente">0</h3>
                                <small class="text-muted" id="kpiMaiorExcedenteCultivar">-</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card p-3 h-100 kpi-card kpi-card-danger">
                                <p class="text-muted mb-0">D√©ficit Total (SC)</p>
                                <h3 class="mb-0" id="kpiDeficitTotal">0</h3>
                                <small class="text-muted">Volume abaixo da previs√£o</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-5">
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h4>üìà Desempenho vs. Proje√ß√£o</h4>
                                <p class="text-muted small">Diferen√ßa entre Recebido e Previsto por Cultivar (valores positivos = excedente)</p>
                                <iframe id="iframeDiffBar" class="plotly-iframe height-400"></iframe>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h4>üéØ Percentual de Atingimento</h4>
                                <p class="text-muted small">Ordenado por % de conclus√£o (100% = meta atingida)</p>
                                <iframe id="iframePercentBar" class="plotly-iframe height-400"></iframe>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-5">
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h4>üìä Distribui√ß√£o por Categoria</h4>
                                <p class="text-muted small">Volume total por categoria (Previsto vs. Recebido)</p>
                                <iframe id="iframeCategoryStacked" class="plotly-iframe height-400"></iframe>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h4>üìã Ranking de Efici√™ncia</h4>
                                <p class="text-muted small">Top 10 cultivares por volume recebido</p>
                                <iframe id="iframeTopCultivars" class="plotly-iframe height-400"></iframe>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card p-3">
                                <h4>üìÖ Linha do Tempo de Recebimento</h4>
                                <p class="text-muted small">Evolu√ß√£o cumulativa do recebimento por categoria</p>
                                <iframe id="iframeTimeline" class="plotly-iframe height-500"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabela" role="tabpanel" tabindex="0">
                <div class="p-3">
                    <h2>Tabela de Dados Brutos (Edi√ß√£o R√°pida)</h2>
                    <div class="row mb-3">
                        <div class="col-12">
                            <p class="text-muted">Clique nas c√©lulas para editar. Status √© atualizado automaticamente (OK/Prev. Inv√°lida) ou pode ser alterado via *dropdown*.</p>
                            <div class="d-flex justify-content-end mb-3">
                                <button class="btn btn-primary" onclick="saveChanges()">Salvar Altera√ß√µes na Tabela</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="dataTable">
                            <thead>
                                <tr>
                                    <th>Cultivar</th>
                                    <th>Categoria</th>
                                    <th>Prev. Colheita (SC)</th>
                                    <th>Prev. Receb (SC)</th>
                                    <th>Recep√ß√£o (SC)</th>
                                    <th>%</th>
                                    <th>Status</th>
                                    <th>Diferen√ßa (SC)</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="cadastro" role="tabpanel" tabindex="0">
                <div class="p-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h3>‚ûï Cadastrar Nova Cultivar</h3>
                                <form id="registerForm" class="mt-3">
                                    <input type="text" name="cultivar" class="form-control mb-2" placeholder="Nome da Cultivar (Ex: TRUNFO)" required>
                                    <input type="text" name="categoria" class="form-control mb-2" placeholder="Categoria (Ex: Grupo 1)" required>
                                    <input type="number" name="prev_colheita" class="form-control mb-2" placeholder="Previs√£o de Colheita (SC)" required step="0.01">
                                    <input type="number" name="prev_receb" class="form-control mb-2" placeholder="Previs√£o de Recep√ß√£o (SC)" required step="0.01">
                                    <input type="number" name="recepcao" class="form-control mb-2" placeholder="Recep√ß√£o Atual (SC)" required step="0.01">
                                    <button type="submit" class="btn btn-success w-100">Cadastrar Cultivar</button>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 h-100">
                                <h3>üì§ Exportar/Importar Dados</h3>
                                
                                <button class="btn btn-primary w-100 mb-3" onclick="exportRelatorio()">Exportar Relat√≥rio Completo (.html com Gr√°ficos)</button>
                                
                                <a href="/export_excel" class="btn btn-info w-100 mb-3">Exportar Tabela de Dados Brutos (.xlsx)</a>
                                
                                <h4 class="mb-2">Compilar Novos Dados (Excel)</h4>
                                <input type="file" id="excelFile" class="form-control mb-2" accept=".xlsx, .xls">
                                <button class="btn btn-warning w-100" onclick="importExcel()">Importar e Compilar</button>
                                <small class="text-danger mt-2">Aten√ß√£o: A importa√ß√£o substitui todos os dados existentes.</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card p-3">
                                <h3>üìÖ Timeline de Recebimento</h3>
                                <p class="text-muted">Importe dados de recebimento por data para visualizar a evolu√ß√£o temporal.</p>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <a href="/export_timeline_template" class="btn btn-info w-100 mb-3">
                                            üì• Baixar Template para Timeline
                                        </a>
                                        <small class="text-muted">Use este template para preencher os dados de recebimento por data.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Importar Dados de Timeline</h5>
                                        <input type="file" id="timelineFile" class="form-control mb-2" accept=".xlsx, .xls">
                                        <button class="btn btn-warning w-100" onclick="importTimelineData()">Importar Dados de Timeline</button>
                                        <small class="text-danger mt-2">Certifique-se de usar o template correto.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card p-3">
                                <h3>üé¨ Apresenta√ß√£o de Slides</h3>
                                <p class="text-muted">Apresente todos os gr√°ficos em modo slideshow autom√°tico.</p>
                                <button class="btn btn-success w-100 mb-3" onclick="window.open('/slideshow', '_blank')">
                                    üé¨ Abrir Slideshow (Controle)
                                </button>
                                <button class="btn btn-info w-100" onclick="window.open('/slideshow_fullscreen', '_blank')">
                                    üì∫ Abrir Slideshow (Tela Cheia)
                                </button>
                                <small class="text-muted mt-2">Use o modo "Tela Cheia" para projetar em outro computador ou tela.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="configModalLabel">‚öôÔ∏è Configura√ß√µes do Dashboard</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            
            <h4 class="mb-3">Cor Principal do Tema</h4>
            <div class="d-flex gap-3 mb-4">
                <button class="btn" style="background-color: #0d6efd; color: white;" onclick="applyTheme('#0d6efd', '#198754', '#ffc107', '#dc3545')">Azul Padr√£o</button>
                <button class="btn" style="background-color: #6f42c1; color: white;" onclick="applyTheme('#6f42c1', '#198754', '#ffc107', '#dc3545')">Roxo (Lavanda)</button>
                <button class="btn" style="background-color: #fd7e14; color: white;" onclick="applyTheme('#fd7e14', '#198754', '#ffc107', '#dc3545')">Laranja (Fogo)</button>
                <button class="btn" style="background-color: #0dcaf0; color: black;" onclick="applyTheme('#0dcaf0', '#198754', '#ffc107', '#dc3545')">Ciano (√Ågua)</button>
                <button class="btn" style="background-color: #198754; color: white;" onclick="applyTheme('#198754', '#198754', '#ffc107', '#dc3545')">Verde (Prim√°rio)</button>
            </div>
            
            <h4 class="mb-3">Editar Nomes das Abas</h4>
            <div id="tabNameEditors">
                </div>
            <hr>
            
            <h4 class="mt-4 mb-3">Editar T√≠tulos dos Gr√°ficos Plotly</h4>
            <div id="graphTitleEditors">
                <div class="input-group mb-2">
                    <span class="input-group-text">1. Barras</span>
                    <input type="text" class="form-control" data-graph-id="barGroupedTitle" value="1. Previsto vs. Recebido (Barras Agrupadas)">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">2. Pizza</span>
                    <input type="text" class="form-control" data-graph-id="treemapTitle" value="2. Propor√ß√£o do Recebido (Gr√°fico de Pizza)">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">3. Sankey</span>
                    <input type="text" class="form-control" data-graph-id="sankeyTitle" value="3. Fluxo de Volume (Sankey Diagram)">
                </div>
            </div>
            
            <button class="btn btn-success mt-4 w-100" onclick="updateTabAndGraphNames()" data-bs-dismiss="modal">Salvar Configura√ß√µes e Atualizar</button>
            
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Registrar o plugin Datalabels globalmente
        Chart.register(ChartDataLabels);

        let currentData = [];
        let charts = {};
        const dataTable = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        const cultivarSelectTableBody = document.getElementById('cultivarSelectTable').getElementsByTagName('tbody')[0];
        
        // --- 1. CONFIGURA√á√ÉO INICIAL VIA JINJA/SERVIDOR ---
        const serverConfig = JSON.parse('{{ config | tojson | safe }}'); 
        
        // Colunas edit√°veis e seus tipos
        const numericColumns = ['Prev_Colheita', 'Prev_Receb', 'Recepcao']; 
        const statusOptions = ['OK', 'Em Andamento', 'Falta Receber', 'Prev. Inv√°lida']; 
        const allTabIds = Object.keys(serverConfig.tabNames);
        const allGraphIds = Object.keys(serverConfig.graphTitles);
        
        // Formatadores
        const numberFormat = new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        const percentFormat = new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        const percentFormatSimple = new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        // --- 2. FUN√á√ïES DE PERSIST√äNCIA E CONFIGURA√á√ÉO ---

        function loadPersistedData() {
            document.getElementById('dashboardTitle').textContent = serverConfig.dashboardTitle;
            
            const theme = serverConfig.theme;
            applyTheme(theme.primary, theme.success, theme.warning, theme.danger, false);

            initializeTabAndGraphNames(); 
        }
        
        function initializeTabAndGraphNames() {
            const tabContainer = document.getElementById('tabNameEditors');
            tabContainer.innerHTML = '';
            
            const persistedTabNames = serverConfig.tabNames; 

            allTabIds.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    const currentText = button.textContent.trim();
                    const parts = currentText.split(' ');
                    const emoji = parts[0]; 
                    const titleWithoutEmoji = persistedTabNames[id] || parts.slice(1).join(' '); 
                    
                    button.textContent = `${emoji} ${titleWithoutEmoji}`;

                    const div = document.createElement('div');
                    div.className = 'input-group mb-2';
                    div.innerHTML = `
                        <span class="input-group-text">${emoji}</span>
                        <input type="text" class="form-control" data-tab-id="${id}" value="${titleWithoutEmoji}">
                    `;
                    tabContainer.appendChild(div);
                }
            });
            
            const graphContainer = document.getElementById('graphTitleEditors');
            const persistedGraphTitles = serverConfig.graphTitles;
            
            allGraphIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const newTitle = persistedGraphTitles[id] || element.textContent.trim();
                    element.textContent = newTitle;
                    
                    const input = graphContainer.querySelector(`[data-graph-id="${id}"]`);
                    if (input) {
                        input.value = newTitle;
                    }
                }
            });
        }
        
        function updateTabAndGraphNames() {
            const newTabNames = {};
            const newGraphTitles = {};
            const newDashboardTitle = document.getElementById('dashboardTitle').textContent.replace(' üåæ', '').trim();
            
            document.querySelectorAll('#tabNameEditors input').forEach(input => {
                const id = input.getAttribute('data-tab-id');
                const newTitle = input.value.trim();
                const button = document.getElementById(id);
                
                if (button && newTitle !== "") {
                    const currentText = button.textContent.trim();
                    const emoji = currentText.split(' ')[0]; 
                    button.textContent = `${emoji} ${newTitle}`;
                    newTabNames[id] = newTitle;
                }
            });
            
            document.querySelectorAll('#graphTitleEditors input').forEach(input => {
                const id = input.getAttribute('data-graph-id');
                const newTitle = input.value.trim();
                const element = document.getElementById(id);
                
                if (element && newTitle !== "") {
                    element.textContent = newTitle;
                    newGraphTitles[id] = newTitle;
                }
            });
            
            fetch('/update_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dashboardTitle: newDashboardTitle + " üåæ",
                    tabNames: newTabNames,
                    graphTitles: newGraphTitles
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erro ao salvar configura√ß√µes no servidor: ' + data.error);
                } else {
                    serverConfig.dashboardTitle = newDashboardTitle + " üåæ";
                    serverConfig.tabNames = {...serverConfig.tabNames, ...newTabNames};
                    serverConfig.graphTitles = {...serverConfig.graphTitles, ...newGraphTitles};
                    loadPlotlyCharts(); 
                }
            })
            .catch(error => alert('Erro de rede ao salvar configura√ß√µes.'));
        }
        
        function applyTheme(primary, success, warning, danger, save = true) {
            document.documentElement.style.setProperty('--primary-color', primary);
            
            const darker = (color) => {
                let [r, g, b] = color.match(/\w\w/g).map(x => parseInt(x, 16));
                r = Math.max(0, r - 20);
                g = Math.max(0, g - 20);
                b = Math.max(0, b - 20);
                return `#${[r, g, b].map(x => x.toString(16).padStart(2, '0')).join('')}`;
            };
            document.documentElement.style.setProperty('--primary-hover-color', darker(primary));
            document.documentElement.style.setProperty('--success-color', success);
            document.documentElement.style.setProperty('--warning-color', warning);
            document.documentElement.style.setProperty('--danger-color', danger);
            
            if (save) {
                fetch('/update_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theme: { primary, success, warning, danger }
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                         alert('Erro ao salvar tema no servidor: ' + data.error);
                    } else {
                        serverConfig.theme = { primary, success, warning, danger };
                        setupChartJSCharts(currentData); 
                    }
                })
                .catch(error => alert('Erro de rede ao salvar tema.'));
            } else {
                setupChartJSCharts(currentData); 
            }
        }

        function editTitle(id) {
            const titleElement = document.getElementById(id);
            const currentTitle = titleElement.textContent.trim();
            const newTitle = prompt(`Digite o novo nome para o dashboard:`, currentTitle.replace('üåæ', '').trim());
            
            if (newTitle !== null && newTitle.trim() !== "") {
                let finalTitle = newTitle.trim() + " üåæ";
                titleElement.textContent = finalTitle;

                fetch('/update_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dashboardTitle: finalTitle })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Erro ao salvar t√≠tulo no servidor: ' + data.error);
                    } else {
                        serverConfig.dashboardTitle = finalTitle;
                    }
                })
                .catch(error => alert('Erro de rede ao salvar t√≠tulo.'));
            }
        }

        // --- 3. FUN√á√ïES DE GR√ÅFICOS E KPIS ---
        
        function updateKPIs(data) {
            const totalPrevisto = data.reduce((sum, item) => sum + item.Prev_Receb, 0);
            const totalRecebido = data.reduce((sum, item) => sum + item.Recepcao, 0);
            const progressoGeral = totalPrevisto > 0 ? totalRecebido / totalPrevisto * 100 : 0;
            const numCultivares = data.length;

            document.getElementById('kpiTotalPrevisto').textContent = numberFormat.format(totalPrevisto);
            document.getElementById('kpiTotalRecebido').textContent = numberFormat.format(totalRecebido);
            document.getElementById('kpiProgressoGeral').textContent = percentFormat.format(progressoGeral) + '%'; 
            document.getElementById('kpiCultivares').textContent = numCultivares;
        }

        function updateAdvancedKPIs(data) {
            let totalExcedente = 0;
            let totalDeficit = 0;
            let cultivaresComExcedente = 0;
            let maiorExcedente = 0;
            let cultivarMaiorExcedente = '';
            
            data.forEach(item => {
                const diff = item.Recepcao - item.Prev_Receb;
                if (diff > 0) {
                    totalExcedente += diff;
                    cultivaresComExcedente++;
                    
                    if (diff > maiorExcedente) {
                        maiorExcedente = diff;
                        cultivarMaiorExcedente = item.Cultivar;
                    }
                } else if (diff < 0) {
                    totalDeficit += Math.abs(diff);
                }
            });
            
            document.getElementById('kpiExcedenteTotal').textContent = numberFormat.format(totalExcedente);
            document.getElementById('kpiDeficitTotal').textContent = numberFormat.format(totalDeficit);
            document.getElementById('kpiCultivaresExcedente').textContent = cultivaresComExcedente;
            document.getElementById('kpiMaiorExcedente').textContent = numberFormat.format(maiorExcedente);
            document.getElementById('kpiMaiorExcedenteCultivar').textContent = cultivarMaiorExcedente || '-';
        }

        function setupChartJSCharts(data) {
            if (charts.status) charts.status.destroy();

            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color');
            const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--warning-color');
            const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger-color');
            
            const dataByStatus = data.reduce((acc, item) => {
                acc[item.Status] = acc[item.Status] || [];
                acc[item.Status].push(item.Cultivar);
                return acc;
            }, {});

            const statusLabels = Object.keys(dataByStatus);
            const statusCounts = statusLabels.map(label => dataByStatus[label].length);
            
            const statusColors = statusLabels.map(label => {
                if (label === 'OK') return successColor;
                if (label === 'Em Andamento') return warningColor;
                if (label === 'Falta Receber') return dangerColor;
                return primaryColor;
            });

            const statusCtx = document.getElementById('chartStatus').getContext('2d');
            charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusCounts,
                        backgroundColor: statusColors
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { 
                        title: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const count = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (count / total * 100).toFixed(1) + '%' : '0%';
                                    const cultivars = dataByStatus[label] || [];
                                    const displayLines = [`${label}: ${count} Cultivar(es) (${percentage})`];

                                    let tempCultivars = [...cultivars];
                                    while(tempCultivars.length > 0) {
                                        const line = tempCultivars.splice(0, 4).join(', ');
                                        displayLines.push(`Cultivares: ${line}`);
                                        if (tempCultivars.length > 0 && displayLines.length >= 6) { 
                                            displayLines.push(`... e mais ${tempCultivars.length} cultivares.`);
                                            break;
                                        }
                                    }
                                    
                                    return displayLines;
                                }
                            }
                        }
                    }
                }
            });
            
            if (data.length > 0) {
                const currentCultivarTitle = document.getElementById('progressTitle').textContent;
                const currentCultivarName = currentCultivarTitle.replace('Progresso de ', '');
                
                const initialCultivar = data.find(c => c.Cultivar === currentCultivarName) || data[0];
                showCultivarProgress(initialCultivar);
            } else {
                showCultivarProgress({Cultivar: "Nenhuma Cultivar", Prev_Receb: 0, Recepcao: 0, '%': 0});
            }
        }
        
        let individualProgressChart;

        function showCultivarProgress(cultivarData) {
            if (individualProgressChart) individualProgressChart.destroy();
            
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color');
            const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--warning-color');

            const percentageForChart = cultivarData['%'] > 100 ? 100 : cultivarData['%'];
            const color = percentageForChart >= 100 ? successColor : warningColor;

            const data = {
                labels: ['Progresso', 'Restante'],
                datasets: [{
                    data: [percentageForChart, 100 - percentageForChart],
                    backgroundColor: [color, '#e9ecef'],
                    borderWidth: 0,
                    circumference: 180, 
                    rotation: 270 
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            };
            
            const ctx = document.getElementById('chartIndividualProgress').getContext('2d');
            individualProgressChart = new Chart(ctx, config);

            document.getElementById('progressTitle').textContent = `Progresso de ${cultivarData.Cultivar}`;
            document.getElementById('progressPercentage').textContent = `${percentFormatSimple.format(cultivarData['%'])}%`;
            document.getElementById('progressDetails').textContent = `Previsto: ${numberFormat.format(cultivarData.Prev_Receb)} SC | Recebido: ${numberFormat.format(cultivarData.Recepcao)} SC`;

            document.querySelectorAll('#cultivarSelectTable tbody tr').forEach(row => {
                row.classList.remove('table-primary');
                if (row.dataset.cultivar === cultivarData.Cultivar) {
                    row.classList.add('table-primary');
                }
            });
        }

        // --- 4. FUN√á√ïES DE TABELA E EDI√á√ÉO ---

        function parseNumber(text) {
             return parseFloat(text.replace(/\./g, '').replace(',', '.'));
        }
        
        function renderTable(data) {
            dataTable.innerHTML = '';
            cultivarSelectTableBody.innerHTML = '';
            currentData = data;

            data.forEach((item, index) => {
                const percentDisplay = percentFormat.format(item['%']);
                const diff = item.Recepcao - item.Prev_Receb;
                const diffClass = diff > 0 ? 'positive-diff' : diff < 0 ? 'negative-diff' : 'neutral-diff';
                const diffDisplay = numberFormat.format(diff);

                // --- Tabela de Sele√ß√£o (Dashboard) ---
                const selectRow = cultivarSelectTableBody.insertRow();
                selectRow.classList.add('cultivar-row');
                selectRow.dataset.cultivar = item.Cultivar;
                selectRow.insertCell().textContent = item.Cultivar;
                selectRow.insertCell().textContent = percentDisplay + '%';
                selectRow.addEventListener('click', () => showCultivarProgress(item));

                // --- Tabela Edit√°vel (Aba Edi√ß√£o R√°pida) ---
                const editRow = dataTable.insertRow();
                const cellMap = ['Cultivar', 'Categoria', 'Prev_Colheita', 'Prev_Receb', 'Recepcao', '%', 'Status'];
                
                cellMap.forEach(key => {
                    const cell = editRow.insertCell();
                    
                    const displayValue = (typeof item[key] === 'number') 
                        ? numberFormat.format(item[key])
                        : item[key];
                    
                    const statusClass = 'status-' + item.Status.toLowerCase().replace(/ /g, '-').replace(/\./g, '');
                    cell.classList.add(statusClass);

                    if (key === 'Status') {
                        const select = document.createElement('select');
                        select.classList.add('form-select', 'form-select-sm');
                        
                        const currentStatus = item.Status;
                        
                        const allOptions = ['OK', 'Prev. Inv√°lida', 'Em Andamento', 'Falta Receber'];
                        
                        if (!allOptions.includes(currentStatus)) {
                            allOptions.push(currentStatus);
                        }

                        allOptions.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            if (option === currentStatus) {
                                opt.selected = true;
                            }
                            select.appendChild(opt);
                        });
                        
                        select.addEventListener('change', (e) => {
                            currentData[index][key] = e.target.value;
                        });
                        
                        cell.appendChild(select);

                    } else if (key === '%') {
                        cell.textContent = percentDisplay + '%';
                    } else if (numericColumns.includes(key) || key === 'Cultivar' || key === 'Categoria') {
                        cell.classList.add('editable-cell');
                        cell.contentEditable = true;
                        cell.textContent = displayValue;
                        
                        cell.addEventListener('blur', (e) => {
                            let newValue = e.target.textContent.trim();
                            
                            if (numericColumns.includes(key)) {
                                newValue = parseNumber(newValue);
                                
                                if (!isNaN(newValue)) {
                                    currentData[index][key] = newValue;
                                    e.target.textContent = numberFormat.format(newValue);
                                } else {
                                    e.target.textContent = numberFormat.format(currentData[index][key]);
                                }
                            } else {
                                currentData[index][key] = newValue;
                            }
                        });
                    } else {
                        cell.textContent = displayValue;
                    }
                });

                // Adicionar c√©lula de diferen√ßa
                const diffCell = editRow.insertCell();
                diffCell.innerHTML = `<span class="${diffClass}">${diffDisplay}</span>`;
            });
        }
        
        function fetchData() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    currentData = data; 
                    renderTable(data);
                    updateKPIs(data);
                    updateAdvancedKPIs(data);
                    setupChartJSCharts(data); 
                    loadPlotlyCharts(); 
                })
                .catch(error => console.error('Erro ao buscar dados:', error));
        }

        function saveChanges() {
            // Garantir que os dados atuais estejam sincronizados
            const tableRows = document.querySelectorAll('#dataTable tbody tr');
            
            tableRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                
                // Atualizar dados da tabela com os valores atuais
                currentData[index].Cultivar = cells[0].textContent.trim();
                currentData[index].Categoria = cells[1].textContent.trim();
                currentData[index].Prev_Colheita = parseNumber(cells[2].textContent);
                currentData[index].Prev_Receb = parseNumber(cells[3].textContent);
                currentData[index].Recepcao = parseNumber(cells[4].textContent);
                
                // Status √© obtido do select
                const statusSelect = cells[6].querySelector('select');
                if (statusSelect) {
                    currentData[index].Status = statusSelect.value;
                }
            });

            fetch('/update_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentData)
            })
            .then(response => response.json())
            .then(updatedData => {
                fetchData(); 
                alert('Dados atualizados e salvos com sucesso!');
            })
            .catch(error => {
                alert('Erro ao salvar as altera√ß√µes. Verifique o console.');
                console.error('Erro ao salvar:', error);
            });
        }

        // --- FUN√á√ÉO PARA ATUALIZAR GR√ÅFICOS PLOTLY ---
        function loadPlotlyCharts() {
            const uniqueStamp = Date.now(); 
            document.getElementById('iframeBarGrouped').src = `${window.location.origin}/graph/bar_grouped?v=${uniqueStamp}`;
            document.getElementById('iframeTreemap').src = `${window.location.origin}/graph/treemap?v=${uniqueStamp}`; 
            document.getElementById('iframeSankey').src = `${window.location.origin}/graph/sankey?v=${uniqueStamp}`;
            
            // NOVOS GR√ÅFICOS
            document.getElementById('iframeDiffBar').src = `${window.location.origin}/graph/diff_bar?v=${uniqueStamp}`;
            document.getElementById('iframePercentBar').src = `${window.location.origin}/graph/percent_bar?v=${uniqueStamp}`;
            document.getElementById('iframeCategoryStacked').src = `${window.location.origin}/graph/category_stacked?v=${uniqueStamp}`;
            document.getElementById('iframeTopCultivars').src = `${window.location.origin}/graph/top_cultivars?v=${uniqueStamp}`;
            document.getElementById('iframeTimeline').src = `${window.location.origin}/graph/timeline?v=${uniqueStamp}`;
        }
        
        // --- FUN√á√ïES DE EXPORTA√á√ÉO, CADASTRO E IMPORTA√á√ÉO ---
        function exportRelatorio() {
            const titles = {};
            titles.barGroupedTitle = document.getElementById('barGroupedTitle').textContent;
            titles.treemapTitle = document.getElementById('treemapTitle').textContent;
            titles.sankeyTitle = document.getElementById('sankeyTitle').textContent;
            
            alert('Gerando relat√≥rio... Por favor, aguarde o download.');

            fetch('/export_relatorio', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ titles: titles })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Erro ao gerar relat√≥rio. Status: ' + response.status);
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'relatorio_recepcao_trigo.html'; 
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Erro na exporta√ß√£o:', error);
                alert('Falha ao exportar o relat√≥rio. Verifique o console para mais detalhes.');
            });
        }
        
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/register', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                document.getElementById('registerForm').reset();
                fetchData();
            })
            .catch(error => console.error('Erro no cadastro:', error));
        });

        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert("Por favor, selecione um arquivo Excel (.xlsx ou .xls) para importar.");
                return;
            }
            
            const formData = new FormData();
            formData.append('excel_file', file);

            fetch('/import_data', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erro na Importa√ß√£o: ' + data.error);
                } else {
                    alert('Dados importados e compilados com sucesso! O dashboard ser√° atualizado.');
                    fetchData();
                }
            })
            .catch(error => {
                alert('Erro desconhecido ao importar o arquivo.');
                console.error('Erro de importa√ß√£o:', error);
            });
        }

        // NOVA FUN√á√ÉO: IMPORTAR DADOS DE TIMELINE
        function importTimelineData() {
            const fileInput = document.getElementById('timelineFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert("Por favor, selecione um arquivo Excel (.xlsx ou .xls) com dados de timeline.");
                return;
            }
            
            const formData = new FormData();
            formData.append('timeline_file', file);

            fetch('/import_timeline_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erro na Importa√ß√£o: ' + data.error);
                } else {
                    alert('Dados de timeline importados com sucesso! Os gr√°ficos ser√£o atualizados.');
                    loadPlotlyCharts(); // Recarrega os gr√°ficos, incluindo a timeline
                }
            })
            .catch(error => {
                alert('Erro desconhecido ao importar o arquivo.');
                console.error('Erro de importa√ß√£o timeline:', error);
            });
        }

        // Garante que o fetch inicial ocorra no carregamento da p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            loadPersistedData();
            fetchData();
        });
    </script>
</body>
</html>