<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Slideshow - Dashboard Trigo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            background: white;
        }
        
        .slide.active {
            display: block;
            animation: fadeIn 1s ease-in-out;
        }
        
        /* T√çTULO RESTAURADO */
        .slide-title {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            z-index: 100;
        }
        
        /* Padding superior ajustado para o t√≠tulo */
        .graph-container {
            width: 100%;
            height: 100%;
            padding: 80px 20px 20px 20px;
            box-sizing: border-box; 
        }

        .graph-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .slide-counter {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            z-index: 100;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .js-plotly-plot .plotly .modebar {
            background: rgba(0, 0, 0, 0.5) !important;
        }
        
        .access-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 2000;
        }
    </style>
</head>
<body>
    {% if session.role != 'admin' %}
    <div class="access-message">
        <h2>‚ö†Ô∏è Acesso Restrito</h2>
        <p class="text-muted">Apenas administradores t√™m acesso ao slideshow.</p>
        <div class="mt-4">
            <a href="/" class="btn btn-primary">Voltar ao Dashboard</a>
            <a href="/logout" class="btn btn-outline-danger ms-2">Sair</a>
        </div>
    </div>
    {% else %}
    
    <div class="slide active" id="slide1">
        <div class="slide-title">üìä Volume Previsto vs. Recebido</div>
        <div class="slide-counter">1/8</div>
        <div class="graph-container" id="graph1"></div>
    </div>

    <div class="slide" id="slide2">
        <div class="slide-title">üçï Propor√ß√£o do Recebido</div>
        <div class="slide-counter">2/8</div>
        <div class="graph-container" id="graph2"></div>
    </div>

    <div class="slide" id="slide3">
        <div class="slide-title">üåä Fluxo de Volume</div>
        <div class="slide-counter">3/8</div>
        <div class="graph-container" id="graph3"></div>
    </div>

    <div class="slide" id="slide4">
        <div class="slide-title">üìà Desempenho vs. Proje√ß√£o</div>
        <div class="slide-counter">4/8</div>
        <div class="graph-container" id="graph4"></div>
    </div>

    <div class="slide" id="slide5">
        <div class="slide-title">üéØ Percentual de Atingimento</div>
        <div class="slide-counter">5/8</div>
        <div class="graph-container" id="graph5"></div>
    </div>

    <div class="slide" id="slide6">
        <div class="slide-title">üì¶ Volume por Categoria</div>
        <div class="slide-counter">6/8</div>
        <div class="graph-container" id="graph6"></div>
    </div>

    <div class="slide" id="slide7">
        <div class="slide-title">üèÜ Top 10 Cultivares</div>
        <div class="slide-counter">7/8</div>
        <div class="graph-container" id="graph7"></div>
    </div>

    <div class="slide" id="slide8">
        <div class="slide-title">üìÖ Evolu√ß√£o do Recebimento</div>
        <div class="slide-counter">8/8</div>
        <div class="graph-container" id="graph8"></div>
    </div>

    <script>
        let currentSlide = 0;
        const totalSlides = 8;
        let eventSource;
        let slideDuration = 5000; // 5 segundos padr√£o

        // URLs dos gr√°ficos
        const graphUrls = [
            '/graph/bar_grouped',
            '/graph/treemap',
            '/graph/sankey',
            '/graph/diff_bar',
            '/graph/percent_bar',
            '/graph/category_stacked',
            '/graph/top_cultivars',
            '/graph/timeline'
        ];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadAllGraphs();
            startSlideshow();
            setupEventSource();
            
            // Atualizar gr√°ficos a cada 30 segundos
            setInterval(loadAllGraphs, 30000);
        });

        // Carregar todos os gr√°ficos
        async function loadAllGraphs() {
            for (let i = 0; i < graphUrls.length; i++) {
                try {
                    const container = document.getElementById(`graph${i + 1}`);
                    
                    if (container.querySelector('iframe')) {
                        const iframe = container.querySelector('iframe');
                        iframe.src = graphUrls[i] + '?t=' + Date.now();
                    } else {
                        container.innerHTML = ''; 
                        const iframe = document.createElement('iframe');
                        iframe.src = graphUrls[i] + '?t=' + Date.now();
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        container.appendChild(iframe);
                    }
                } catch (error) {
                    console.error(`Erro ao carregar gr√°fico ${i + 1}:`, error);
                }
            }
        }

        // Slideshow autom√°tico
        function startSlideshow() {
            setInterval(nextSlide, slideDuration);
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % totalSlides;
            showSlide(currentSlide);
        }

        function showSlide(slideIndex) {
            document.querySelectorAll('.slide').forEach(slide => {
                slide.classList.remove('active');
            });
            
            document.getElementById(`slide${slideIndex + 1}`).classList.add('active');
        }

        // --- FUN√á√ÉO DE TELA CHEIA ---
        function toggleFullScreen() {
            if (!document.fullscreenElement &&    // Padr√£o
                !document.mozFullScreenElement && // Firefox
                !document.webkitFullscreenElement && // Chrome, Safari, Opera
                !document.msFullscreenElement) {  // IE/Edge
                
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) { // Firefox
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) { // Chrome, Safari, Opera
                    elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (elem.msRequestFullscreen) { // IE/Edge
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari, Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        }

        // WebSocket/EventSource para controle remoto (opcional)
        function setupEventSource() {
            try {
                eventSource = new EventSource('/slideshow_events');
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.type === 'slide_change') {
                        currentSlide = data.slideIndex;
                        showSlide(currentSlide);
                    } else if (data.type === 'speed_change') {
                        slideDuration = data.duration;
                    }
                };
                
                eventSource.onerror = function() {
                    console.warn("Conex√£o EventSource falhou.");
                };
                
            } catch (error) {
                console.log('EventSource n√£o suportado, usando modo aut√¥nomo');
            }
        }

        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });

        // Controles de teclado para apresentador
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'ArrowLeft':
                    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
                    showSlide(currentSlide);
                    break;
                case 'ArrowRight':
                    currentSlide = (currentSlide + 1) % totalSlides;
                    showSlide(currentSlide);
                    break;
                case 'Escape':
                    window.location.href = '/';
                    break;
                case 'f':
                    toggleFullScreen();
                    break;
                case 'Enter':
                    event.preventDefault(); 
                    toggleFullScreen();
                    break;
            }
        });
    </script>
    {% endif %}
</body>
</html>